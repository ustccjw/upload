!function t(e,n,i){function r(s,u){if(!n[s]){if(!e[s]){var a="function"==typeof require&&require;if(!u&&a)return a(s,!0);if(o)return o(s,!0);var f=new Error("Cannot find module '"+s+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[s]={exports:{}};e[s][0].call(l.exports,function(t){var n=e[s][1][t];return r(n?n:t)},l,l.exports,t,e,n,i)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}({1:[function(t){function e(t,e){return"object"==typeof t&&(e=t,t="upyun"),t=t||"upyun","object"!=typeof e&&(e={}),o("image",t).then(function(t){return $.extend(t,{accept:"image/*",timeout:1e4,compress:{max_width:300,max_height:300}},e),new r(t)})}function n(t,e,n){t=t||"upyun";var i=e.url||e.upload_ret.url;return i=i.split("#")[0],n=n?"_"+n:"_sq","upyun"===t?"http://img"+(i.charCodeAt(1)%3+4)+".baixing.net"+i+n:"qiniu"===t?"http://img7.baixing.net/"+i+n:void 0}function i(t,e){t=t||"upyun";var n=e.url||e.upload_ret.url;n=n.split("#")[0];var i="";return"upyun"===t||"upyun_im"===t?i="#up":"qiniu"===t&&(i="#qn"),n+i}var r=t("./lib/upload"),o=t("./lib/vendor_config");$(function(){$("[data-image-upload]").each(function(t,r){var o=$(r).data("vendor"),s=$(r).data("accept"),u=$(r).data("suffix");e(o,{trigger:$(r),accept:s,success:function(t,e){if("string"==typeof t&&(t=$.parseJSON(t)),200===t.code||"qiniu"===o&&!t.error){var s=n(o,t,u),a=i(o,t);$(r).trigger("imageUploadSuccess",[s,a,e])}else $(r).trigger("imageUploadError",[t.message||t.error,e])},error:function(t,e){$(r).trigger("imageUploadError",[t.message,e])},progress:function(){$(r).trigger("imageUploadProgress",[].slice.call(arguments,0))},select:function(){$(r).trigger("imageUploadSelect",[].slice.call(arguments,0)),this.submit()}})["catch"](function(t){console.log(t)})})})},{"./lib/upload":3,"./lib/vendor_config":4}],2:[function(t,e){(function(t){"use strict";function n(t,e){return e===!1?Promise.resolve(t):window.File&&window.FileReader&&window.URL?t instanceof File?/image/i.test(t.type)?("object"!=typeof e&&(e={}),new Promise(function(n){var o=new FileReader;o.readAsArrayBuffer(t),o.onload=function(o){var s=new Blob([o.target.result]);window.URL=window.URL||window.webkitURL;var u=window.URL.createObjectURL(s),a=new Image;a.src=u,a.onload=function(){var o=i(a,t.type,e),s=r(o);n(s)}}})):Promise.reject(new Error("file is not image")):Promise.reject(new Error("file invalid")):Promise.reject(new Error("File API not support"))}function i(t,e,n){var i=t.width,r=t.height,o=n.max_width||i,s=n.max_height||r,u=n.quality||null;i>r?i>o&&(r=Math.round(r*=o/i),i=o):r>s&&(i=Math.round(i*=s/r),r=s);var a=document.createElement("canvas");a.width=i,a.height=r;var f=a.getContext("2d");return f.drawImage(t,0,0,i,r),a.toDataURL(e,u)}function r(t){var e="";e=t.split(",")[0].indexOf("base64")>=0?atob(t.split(",")[1]):unescape(t.split(",")[1]);for(var n=t.split(",")[0].split(":")[1].split(";")[0],i=new Uint8Array(e.length),r=0;r<e.length;r++)i[r]=e.charCodeAt(r);return new Blob([i],{type:n})}var o="undefined"!=typeof window?window.ES6Promise:"undefined"!=typeof t?t.ES6Promise:null;o.polyfill(),e.exports=n}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],3:[function(t,e){(function(n){"use strict";function i(t){if(!(this instanceof i))return new i(t);"object"!=typeof t&&(t={});var e={trigger:null,name:"file",action:"/upload",accept:null,data:null,multiple:!0,select:null,error:null,success:null,progress:null,compress:!1,timeout:null};if($.extend(e,t),this.settings=e,!$(this.settings.trigger).length)throw Error("config error: trigger invalid");this.setup(),this.bind()}function r(t){return t?$.map(t,function(t,e){return $("<input></input>").attr({type:"hidden",name:e,value:t})}):[]}function o(t){var e=0;return $.each(t.parents(),function(t,n){return n===$("body")[0]?!1:void("static"!==$(n).css("position")&&(e=parseInt($(n).css("zIndex"),10)||e))}),e}function s(){return $("<iframe></iframe>").attr({name:"iframe-Upload-"+f++}).hide()}var u="undefined"!=typeof window?window.ES6Promise:"undefined"!=typeof n?n.ES6Promise:null,a=t("./compress");u.polyfill();var f=0,l=0;i.prototype.setup=function(){this.form=$("<form></from>").attr({method:"post",enctype:"multipart/form-data",action:this.settings.action}),this.form.append(r(this.settings.data)),this.input=$("<input></input>").attr({type:"file",name:this.settings.name,accept:this.settings.accept||"",multiple:!!this.settings.multiple});var t=$(this.settings.trigger),e=t.outerWidth?t.outerWidth():t[0].offsetWidth,n=t.outerHeight?t.outerHeight():t[0].offsetHeight;this.input.attr("hidefocus",!0).css({position:"absolute",left:0,top:0,width:e,height:n,opacity:0,outline:0,cursor:"pointer"}),this.form.append(this.input),this.form.css({position:"absolute",top:t.offset().top,left:t.offset().left,width:e,height:n,overflow:"hidden",zIndex:o(t)+10}).appendTo("body")},i.prototype.bind=function(){var t=this,e=$(t.settings.trigger),n=e.outerWidth?e.outerWidth():e[0].offsetWidth,i=e.outerHeight?e.outerHeight():e[0].offsetHeight;e.mouseenter(function(){t.form.css({top:e.offset().top,left:e.offset().left,width:n,height:i}).show()}),t.bindInput()},i.prototype.bindInput=function(){var t=this;t.files=[],t.input.on("change",function(e){t.files=this.files||[{name:e.target.value.split("\\").pop()}],t.uids=$.map(t.files,function(){return l++}),t.settings.select?t.settings.select.call(t,t.files,t.uids):t.submit()})},i.prototype.submit=function(){var t=this,e=null;return e=window.FormData?t.ajaxSubmit(t.files,t.uids):t.formSubmit(t.uids[0]),t.refreshInput(),e.then(function(){t.form.hide()})},i.prototype.ajaxSubmit=function(t,e){var n=this,i=[];return $.each(t,function(t,r){var o=a(r,n.settings.compress)["catch"](function(){return r}).then(function(e){n.input.prop("disabled",!0);var i=new FormData(n.form.get(0));return i.append(n.settings.name,e,r.name),n.input.prop("disabled",!1),new Promise(function(e,r){$.ajax({url:n.settings.action,type:"post",processData:!1,contentType:!1,data:i,timeout:n.settings.timeout,xhr:function(){var e=$.ajaxSettings.xhr();return e.upload&&n.settings.progress&&e.upload.addEventListener("progress",function(e){var i=0,r=e.loaded||e.position,o=e.total;e.lengthComputable&&(i=Math.ceil(r/o*100)),n.settings.progress(r,o,i,n.uids[t])},!1),e},success:function(t){e(t)},error:function(t,e,n){n&&(n=" "+n);var i="upload error: "+e+n;r(new Error(i))}})})}).then(function(i){n.settings.success&&n.settings.success(i,e[t])},function(i){n.settings.error&&n.settings.error(i,e[t])});i.push(o)}),Promise.all(i)},i.prototype.formSubmit=function(t){var e=this;return new Promise(function(t,n){e.iframe=s(),e.form.attr("target",e.iframe.attr("name")),$("body").append(e.iframe);var i=null;e.iframe.one("load",function(){if(null!==i){void 0!==i&&clearTimeout(i),$('<iframe src="javascript:false;"></iframe>').appendTo(e.form).remove();var n=$.trim($(this).contents().find("body").html());t(n)}}),e.form.submit(),i=e.settings.timeout>0?setTimeout(function(){n(new Error("upload error: timeout")),i=null},e.settings.timeout):void 0}).then(function(n){e.settings.success&&e.settings.success(n,t)},function(n){e.settings.error&&e.settings.error(n,t)}).then(function(){e.iframe.remove()})},i.prototype.refreshInput=function(){var t=this.input.clone();this.input.before(t),this.input.off("change"),this.input.remove(),this.input=t,this.bindInput()},i.prototype.select=function(t){return t?(this.settings.select=t,this):this},i.prototype.success=function(t){return t?(this.settings.success=t,this):this},i.prototype.error=function(t){return t?(this.settings.error=t,this):this},i.prototype.progress=function(t){return t?(this.settings.progress=t,this):this},e.exports=i}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./compress":2}],4:[function(t,e){(function(t){"use strict";function n(t,e){return new Promise(function(n,i){$.ajax({url:t,data:e,dataType:"json",success:function(t){t.success?n(t.message):i(new Error("server_config error: "+t.message))},error:function(t,e,n){n&&(n=" "+n),i(new Error("server_config error: "+e+n))}})})}function i(t,e){if("image"===t){window.location.origin=window.location.origin||window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"");var i=window.location.origin+"/imageUpload/getConfig/",r={vendor:e,"return-url":window.location.origin+"/imageUpload/getResult/"};window.FormData&&delete r["return-url"];var o=window[e.toUpperCase()];return o?Promise.resolve({action:o.uploadUrl,data:o.uploadParams,name:o.fileKey}):n(i,r).then(function(t){return window[e.toUpperCase()]=t,{action:t.uploadUrl,data:t.uploadParams,name:t.fileKey}})}return Promise.reject(new Error("server_config error: media type invalid"))}var r="undefined"!=typeof window?window.ES6Promise:"undefined"!=typeof t?t.ES6Promise:null;r.polyfill(),e.exports=i}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1]);
//# sourceMappingURL=image_upload.min.js.map