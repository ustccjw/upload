{"version":3,"sources":["upload.min.js"],"names":["e","exports","module","define","amd","f","window","global","self","Upload","t","n","r","s","o","u","a","require","i","Error","code","l","call","length",1,"options","this","settings","trigger","name","action","accept","data","multiple","select","error","success","progress","compress","timeout","$","extend","setup","bind","createInputs","map","value","key","document","createElement","attr","type","findzIndex","$node","zIndex","each","parents","index","item","css","parseInt","newIframe","iframeName","iframeCount","iframe","hide","ES6Promise","polyfill","uid","prototype","form","method","enctype","append","input","$trigger","outerWidth","offsetWidth","outerHeight","offsetHeight","position","left","top","width","height","opacity","outline","cursor","offset","overflow","appendTo","on","show","bindInput","files","target","split","pop","uids","submit","promise","FormData","ajaxSubmit","formSubmit","refreshInput","then","promiseArr","file","blob","prop","get","Promise","resolve","reject","ajax","url","processData","contentType","xhr","ajaxSettings","upload","addEventListener","event","percent","loaded","total","lengthComputable","Math","ceil","textStatus","errorThrown","message","err","push","all","timer","one","undefined","clearTimeout","remove","response","trim","contents","find","html","setTimeout","newInput","clone","before","off","callback","./compress",2,"File","FileReader","URL","test","reader","readAsArrayBuffer","onload","Blob","result","webkitURL","blobURL","createObjectURL","image","Image","src","dataURI","resize","dataURItoBlob","img","max_width","max_height","quality","round","canvas","ctx","getContext","drawImage","toDataURL","byteString","indexOf","atob","unescape","mimeString","ia","Uint8Array","charCodeAt"],"mappings":"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","file":"upload.min.js","sourcesContent":["!function(e){if(\"object\"==typeof exports&&\"undefined\"!=typeof module)module.exports=e();else if(\"function\"==typeof define&&define.amd)define([],e);else{var f;\"undefined\"!=typeof window?f=window:\"undefined\"!=typeof global?f=global:\"undefined\"!=typeof self&&(f=self),f.Upload=e()}}(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n(function (global){\n/*\n * Base on arale/upload\n * error message: 'upload error: xxxx' (mostly)\n * error will call settings.error function\n */\n\n'use strict'\n\nvar ES6Promise = (typeof window !== \"undefined\" ? window.ES6Promise : typeof global !== \"undefined\" ? global.ES6Promise : null)\nvar compress = require('./compress')\n\nES6Promise.polyfill()\nvar iframeCount = 0\nvar uid = 0\n\n/**\n * Upload constructor\n * @param {Object} options config\n */\nfunction Upload(options) {\n\tif (!(this instanceof Upload)) {\n\t\treturn new Upload(options)\n\t}\n\tif (typeof options !== 'object') {\n\t\toptions = {}\n\t}\n\tvar settings = {\n\t\ttrigger: null,\n\t\tname: 'file',\n\t\taction: '/upload',\n\t\taccept: null,\n\t\tdata: null,\n\t\tmultiple: true,\n\t\tselect: null,\n\t\terror: null,\n\t\tsuccess: null,\n\t\tprogress: null,\n\t\tcompress: false,\n\t\ttimeout: null\n\t}\n\t$.extend(settings, options)\n\tthis.settings = settings\n\tif (!$(this.settings.trigger).length) {\n\t\tthrow Error('config error: trigger invalid')\n\t}\n\n\tthis.setup()\n\tthis.bind()\n}\n\n/**\n * init form that contains hidden data input and transparency file input\n */\nUpload.prototype.setup = function () {\n\tthis.form = $(document.createElement('form')).attr({\n\t\tmethod: 'post',\n\t\tenctype: 'multipart/form-data',\n\t\taction: this.settings.action\n\t})\n\tthis.form.append(createInputs(this.settings.data))\n\n\tthis.input = $(document.createElement('input')).attr({\n\t\ttype: 'file',\n\t\tname: this.settings.name,\n\t\taccept: this.settings.accept || '',\n\t\tmultiple: !!this.settings.multiple\n\t})\n\tvar $trigger = $(this.settings.trigger)\n\tvar outerWidth = $trigger.outerWidth ?  $trigger.outerWidth() : $trigger[0].offsetWidth\n\tvar outerHeight = $trigger.outerHeight ?  $trigger.outerHeight() : $trigger[0].offsetHeight\n\tthis.input.attr('hidefocus', true).css({\n\t\tposition: 'absolute',\n\t\tleft: 0,\n\t\ttop: 0,\n\t\twidth: outerWidth,\n\t\theight: outerHeight,\n\t\topacity: 0,\n\t\toutline: 0,\n\t\tcursor: 'pointer'\n\t})\n\tthis.form.append(this.input)\n\tthis.form.css({\n\t\tposition: 'absolute',\n\t\ttop: $trigger.offset().top,\n\t\tleft: $trigger.offset().left,\n\t\twidth: outerWidth,\n\t\theight: outerHeight,\n\t\toverflow: 'hidden',\n\t\tzIndex: findzIndex($trigger) + 10\n\t}).appendTo('body')\n}\n\n/**\n * bind the trigger element to form\n */\nUpload.prototype.bind = function () {\n\tvar self = this\n\tvar $trigger = $(self.settings.trigger)\n\tvar outerWidth = $trigger.outerWidth ?  $trigger.outerWidth() : $trigger[0].offsetWidth\n\tvar outerHeight = $trigger.outerHeight ?  $trigger.outerHeight() : $trigger[0].offsetHeight\n\t$trigger.on('mouseenter', function () {\n\t\tself.form.css({\n\t\t\ttop: $trigger.offset().top,\n\t\t\tleft: $trigger.offset().left,\n\t\t\twidth: outerWidth,\n\t\t\theight: outerHeight\n\t\t}).show()\n\t})\n\tself.bindInput()\n}\n\n/**\n * handle file input change event\n */\nUpload.prototype.bindInput = function () {\n\tvar self = this\n\tself.files = []\n\n\tself.input.on('change', function(e) {\n\n\t\t// ie9- don't support FileList Object\n\t\tself.files = this.files || [{\n\t\t\tname: e.target.value.split('\\\\').pop()\n\t\t}]\n\t\tself.uids = $.map(self.files, function (file, index) {\n\t\t\treturn uid++\n\t\t})\n\t\tif (self.settings.select) {\n\t\t\tself.settings.select.call(self, self.files, self.uids)\n\t\t} else {\n\t\t\tself.submit()\n\t\t}\n\t})\n}\n\n/**\n * upload file to server\n * use ajax or form\n * refresh file input when trigger submit\n * @return {Promise}   upload completed primise\n */\nUpload.prototype.submit = function () {\n\tvar self = this\n\tvar promise = null\n\tif (window.FormData) {\n\t\tpromise = self.ajaxSubmit(self.files, self.uids)\n\t} else {\n\t\tpromise = self.formSubmit(self.uids[0])\n\t}\n\tself.refreshInput()\n\n\t// hide form, avoid trigger position vary\n\treturn promise.then(function () {\n\t\tself.form.hide()\n\t})\n}\n\n/**\n * upload file by ajax\n * it will be compressed\n * success or error will trigger callback function\n * @param  {Array}   files   upload files\n * @param  {Array}   uids    the files's uids\n * @return {Promise}         upload completed promise\n */\nUpload.prototype.ajaxSubmit = function (files, uids) {\n\tvar self = this\n\n\t// upyun server do not support multiple files upload\n\tvar promiseArr = []\n\t$.each(files, function (index, file) {\n\t\tvar promise = compress(file, self.settings.compress)['catch'](function (err) {\n\n\t\t\t// compress error then go on uploading\n\t\t\treturn file\n\t\t}).then(function (blob) {\n\n\t\t\t// add data and file\n\t\t\tself.input.prop('disabled', true)\n\t\t\tvar form = new FormData(self.form.get(0))\n\t\t\tform.append(self.settings.name, blob, file.name)\n\t\t\tself.input.prop('disabled', false)\n\t\t\treturn new Promise(function (resolve, reject) {\n\t\t\t\t$.ajax({\n\t\t\t\t\turl: self.settings.action,\n\t\t\t\t\ttype: 'post',\n\t\t\t\t\tprocessData: false,\n\t\t\t\t\tcontentType: false,\n\t\t\t\t\tdata: form,\n\t\t\t\t\ttimeout: self.settings.timeout,\n\t\t\t\t\txhr: function () {\n\t\t\t\t\t\tvar xhr = $.ajaxSettings.xhr()\n\t\t\t\t\t\tif (xhr.upload && self.settings.progress) {\n\t\t\t\t\t\t\txhr.upload.addEventListener('progress', function(event) {\n\t\t\t\t\t\t\t\tvar percent = 0\n\t\t\t\t\t\t\t\tvar position = event.loaded || event.position\n\t\t\t\t\t\t\t\tvar total = event.total\n\t\t\t\t\t\t\t\tif (event.lengthComputable) {\n\t\t\t\t\t\t\t\t\tpercent = Math.ceil(position / total * 100)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tself.settings.progress(position, total, percent, self.uids[index])\n\t\t\t\t\t\t\t}, false)\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn xhr\n\t\t\t\t\t},\n\t\t\t\t\tsuccess: function (data) {\n\t\t\t\t\t\tresolve(data)\n\t\t\t\t\t},\n\t\t\t\t\terror: function (xhr, textStatus, errorThrown) {\n\t\t\t\t\t\tif (errorThrown) {\n\t\t\t\t\t\t\terrorThrown = ' ' + errorThrown\n\t\t\t\t\t\t}\n\t\t\t\t\t\tvar message = 'upload error: ' + textStatus + errorThrown\n\t\t\t\t\t\treject(new Error(message))\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t})\n\t\t}).then(function (data) {\n\n\t\t\t// upload success\n\t\t\tif (self.settings.success) {\n\t\t\t\tself.settings.success(data, uids[index])\n\t\t\t}\n\t\t}, function (err) {\n\n\t\t\t// upload error\n\t\t\tif (self.settings.error) {\n\t\t\t\tself.settings.error(err, uids[index])\n\t\t\t}\n\t\t})\n\t\tpromiseArr.push(promise)\n\t})\n\treturn Promise.all(promiseArr)\n}\n\n/**\n * upload file by form submit\n * success or error will trigger callback function\n * @param  {number}   uid  file uid\n * @return {Promise}       upload completed promise\n */\nUpload.prototype.formSubmit = function (uid) {\n\tvar self = this\n\n\treturn new Promise(function (resolve, reject) {\n\n\t\t// combine form and iframe\n\t\tself.iframe = newIframe()\n\t\tself.form.attr('target', self.iframe.attr('name'))\n\t\t$('body').append(self.iframe)\n\n\t\t// bind iframe load event\n\t\tvar timer = null\n\t\tself.iframe.one('load', function () {\n\n\t\t\t// has timeout\n\t\t\tif (timer === null) {\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\t// timer exist\n\t\t\tif (timer !== undefined) {\n\t\t\t\tclearTimeout(timer)\n\t\t\t}\n\n\t\t\t// Fix for IE endless progress bar activity bug (happens on form submits to iframe targets)\n\t\t\tvar iframe = '<iframe src=\"javascript:false;\"></iframe>'\n\t\t\t$(document.createElement(iframe)).\n\t\t\t\tappendTo(self.form).\n\t\t\t\tremove()\n\n\t\t\t// cross domain try/catch\n\t\t\ttry {\n\t\t\t\tvar response = $.trim($(this).contents().find(\"body\").html())\n\t\t\t} catch (err) {\n\t\t\t\treject(new Error('upload error: cross domain'))\n\t\t\t}\n\t\t\tresolve(response)\n\t\t})\n\t\tself.form.submit()\n\n\t\t// add timer\n\t\tif (self.settings.timeout > 0) {\n\t\t\ttimer = setTimeout(function () {\n\t\t\t\treject(new Error('upload error: timeout'))\n\t\t\t\ttimer = null\n\t\t\t}, self.settings.timeout)\n\t\t} else {\n\t\t\ttimer = undefined\n\t\t}\n\t}).then(function (data) {\n\n\t\t// upload success\n\t\tif (self.settings.success) {\n\t\t\tself.settings.success(data, uid)\n\t\t}\n\t}, function (err) {\n\n\t\t// upload error\n\t\tif (self.settings.error) {\n\t\t\tself.settings.error(err, uid)\n\t\t}\n\t}).then(function () {\n\n\t\t// upload finished then remove iframe\n\t\tself.iframe.remove()\n\t})\n}\n\n/**\n * update the input element\n * or the same file can not upload\n */\nUpload.prototype.refreshInput = function () {\n\tvar newInput = this.input.clone()\n\tthis.input.before(newInput)\n\tthis.input.off('change')\n\tthis.input.remove()\n\tthis.input = newInput\n\tthis.bindInput()\n}\n\n/**\n * set settings.select\n * @param  {Function} callback override settings.select\n * @return {Object}            upload object\n */\nUpload.prototype.select = function (callback) {\n\tif (!callback) {\n\t\treturn this\n\t}\n\tthis.settings.select = callback\n\treturn this\n}\n\n/**\n * set settings.success\n * @param  {Function} callback override settings.success\n * @return {Object}            upload object\n */\nUpload.prototype.success = function (callback) {\n\tif (!callback) {\n\t\treturn this\n\t}\n\tthis.settings.success = callback\n\treturn this\n}\n\n/**\n * set settings.error\n * @param  {Function} callback override settings.error\n * @return {Object}            upload object\n */\nUpload.prototype.error = function (callback) {\n\tif (!callback) {\n\t\treturn this\n\t}\n\tthis.settings.error = callback\n\treturn this\n}\n\n/**\n * set settings.progress\n * @param  {Function} callback override settings.progress\n * @return {Object}            upload object\n */\nUpload.prototype.progress = function (callback) {\n\tif (!callback) {\n\t\treturn this\n\t}\n\tthis.settings.progress = callback\n\treturn this\n}\n\n/**\n * create hidden input for data\n * @param  {Object} data settings.data\n * @return {Array}       array of hidden input\n */\nfunction createInputs(data) {\n\tif (!data) return []\n\treturn $.map(data, function (value, key) {\n\t\treturn $(document.createElement('input')).attr({\n\t\t\ttype: 'hidden',\n\t\t\tname: key,\n\t\t\tvalue: value\n\t\t})\n\t})\n}\n\n/**\n * find the parents' max zIndex\n * @param  {jQueryElement} $node\n * @return {number}               parents max_zIndex\n */\nfunction findzIndex($node) {\n\tvar zIndex = 0\n\t$.each($node.parents(), function (index, item) {\n\t\tif (item === $('body')[0]) {\n\t\t\treturn false\n\t\t}\n\t\tif ($(item).css('position') !== 'static') {\n\t\t\tzIndex = parseInt($(item).css('zIndex'), 10) || zIndex\n\t\t}\n\t})\n\treturn zIndex\n}\n\n/**\n * create new iframe when trigger form submit\n * @return {jQueryElement} iframe element of jQuery\n */\nfunction newIframe() {\n\tvar iframeName = 'iframe-uploader-' + iframeCount\n\tvar iframe = '<iframe name=\"' + iframeName + '\" />'\n\n\t// IE7: iframe.name can not be seted\n\t// http://terminalapp.net/submitting-a-form-with-target-set-to-a-script-generated-iframe-on-ie/\n\treturn $(document.createElement(iframe)).hide()\n}\n\nmodule.exports = Upload\n\n}).call(this,typeof global !== \"undefined\" ? global : typeof self !== \"undefined\" ? self : typeof window !== \"undefined\" ? window : {})\n},{\"./compress\":2}],2:[function(require,module,exports){\n(function (global){\n'use strict'\n\nvar ES6Promise = (typeof window !== \"undefined\" ? window.ES6Promise : typeof global !== \"undefined\" ? global.ES6Promise : null)\nES6Promise.polyfill()\n\n/**\n * compress (now only support image)\n * @param  {File}    file\n * @param  {object}  options {max_width, max_height, quality}\n * @return {Promise}\n */\nfunction compress(file, options) {\n\n\t// do not need to compress\n\tif (options === false) {\n\t\treturn Promise.resolve(file)\n\t}\n\n\t// check File API support\n\tif (!window.File || !window.FileReader || !window.URL) {\n\t\treturn Promise.reject(new Error('File API not support'))\n\t}\n\n\t// check file param\n\tif (!(file instanceof File)) {\n\t\treturn Promise.reject(new Error('file invalid'))\n\t}\n\n\t// can not compress\n\tif (!(/image/i).test(file.type)) {\n\t\treturn Promise.reject(new Error('file is not image'))\n\t}\n\tif (typeof options !== 'object') {\n\t\toptions = {}\n\t}\n\treturn new Promise(function (resolve, reject) {\n\n\t\t// read the files\n\t\tvar reader = new FileReader()\n\t\treader.readAsArrayBuffer(file)\n\t\treader.onload = function (event) {\n\n\t\t\t// blob stuff\n\t\t\ttry {\n\t\t\t\tvar blob = new Blob([event.target.result])\n\t\t\t\twindow.URL = window.URL || window.webkitURL\n\t\t\t\tvar blobURL = window.URL.createObjectURL(blob)\n\n\t\t\t\t// helper Image object\n\t\t\t\tvar image = new Image()\n\t\t\t\timage.src = blobURL\n\t\t\t\timage.onload = function() {\n\n\t\t\t\t\t// send it to canvas\n\t\t\t\t\ttry {\n\t\t\t\t\t\tvar dataURI = resize(image, file.type, options)\n\t\t\t\t\t\tvar blob = dataURItoBlob(dataURI)\n\t\t\t\t\t\tresolve(blob)\n\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\treject(err)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\treject(err)\n\t\t\t}\n\t\t}\n\t})\n}\n\n/**\n * resize Image through canvas\n * @param  {Image}  img      DOM Element\n * @param  {string} type     MIME-STRING\n * @param  {number} options  {max_width, max_height, quality}\n * @return {string}          base64/URLEncoded data\n */\nfunction resize(img, type, options) {\n\tvar width = img.width\n\tvar height = img.height\n\tvar max_width = options.max_width || width\n\tvar max_height = options.max_height || height\n\tvar quality = options.quality || null\n\n\t// calculate the width and height, constraining the proportions\n\tif (width > height) {\n\t\tif (width > max_width) {\n\t\t\theight = Math.round(height *= max_width / width)\n\t\t\twidth = max_width\n\t\t}\n\t} else {\n\t\tif (height > max_height) {\n\t\t\twidth = Math.round(width *= max_height / height)\n\t\t\theight = max_height\n\t\t}\n\t}\n\n\t// resize the canvas and draw the image data into it\n\tvar canvas = document.createElement('canvas')\n\tcanvas.width = width\n\tcanvas.height = height\n\tvar ctx = canvas.getContext(\"2d\")\n\tctx.drawImage(img, 0, 0, width, height)\n\treturn canvas.toDataURL(type, quality)\n}\n\n/**\n * convert base64/URLEncoded data component to raw binary data held in a string\n * @param  {string} dataURI base64/URLEncoded data\n * @return {string}         raw binary data\n */\nfunction dataURItoBlob(dataURI) {\n\tvar byteString = ''\n\tif (dataURI.split(',')[0].indexOf('base64') >= 0) {\n\t\tbyteString = atob(dataURI.split(',')[1])\n\t}\n\telse {\n\t\tbyteString = unescape(dataURI.split(',')[1])\n\t}\n\n\t// separate out the mime component\n\tvar mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]\n\n\t// write the bytes of the string to a typed array\n\tvar ia = new Uint8Array(byteString.length)\n\tfor (var i = 0; i < byteString.length; i++) {\n\t\tia[i] = byteString.charCodeAt(i)\n\t}\n\treturn new Blob([ia], {type: mimeString})\n}\n\nmodule.exports = compress\n\n}).call(this,typeof global !== \"undefined\" ? global : typeof self !== \"undefined\" ? self : typeof window !== \"undefined\" ? window : {})\n},{}]},{},[1])(1)\n});"],"sourceRoot":"/source/"}