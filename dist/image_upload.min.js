!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.imageUpload=e()}}(function(){return function e(t,n,i){function r(s,a){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var f=n[s]={exports:{}};t[s][0].call(f.exports,function(e){var n=t[s][1][e];return r(n?n:e)},f,f.exports,e,t,n,i)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}({1:[function(e,t){function n(e,t){return"object"==typeof e&&(t=e,e="upyun"),e=e||"upyun","object"!=typeof t&&(t={}),r.getConfig("image",e).then(function(e){return $.extend(e,{accept:"image/*",compress:{max_width:300,max_height:300}},t),new i(e)})}var i=e("./lib/upload"),r=e("./lib/vendor");getThumbnailUrl=function(e,t,n){e=e||"upyun";var i=t.url||t.upload_ret.url;if(n=n?"_"+n:"_sq","upyun"===e){i=i.replace(/\.$/,"").split(".");var r=i[1]?"."+i[1]:"";return i=i[0],"http://img"+(i.charCodeAt(1)%3+4)+".baixing.net"+i+r+n}return"qiniu"===e?"http://img7.baixing.net/"+i.split("#")[0]+n:void 0},getUrl=function(e,t){e=e||"upyun";var n=t.url||t.upload_ret.url,i="";return"upyun"===e||"upyun_im"===e?i="#up":"qiniu"===e&&(i="#qn"),n+i},t.exports=n,$(function(){$("[data-image-upload]").each(function(e,t){var i=$(t).data("vendor"),r=$(t).data("suffix");n(i,{trigger:$(t),success:function(e,n){if("string"==typeof e&&(e=$.parseJSON(e)),200===e.code||"qiniu"===i&&!e.error){var o=getThumbnailUrl(i,e,r),s=getUrl(i,e);$(t).trigger("imageUploadSuccess",[o,s,n])}else $(t).trigger("imageUploadError",[e.message||e.error,n])},error:function(e,n){-1===e.message.indexOf("compress error")&&$(t).trigger("imageUploadError",[e.message,n])},progress:function(){$(t).trigger("imageUploadProgress",arguments)},select:function(){$(t).trigger("imageUploadSelect",arguments),this.submit()}})["catch"](function(e){$(t).trigger("imageUploadError",e.message)})})})},{"./lib/upload":3,"./lib/vendor":4}],2:[function(e,t){(function(e){"use strict";function n(e,t){return t===!1?Promise.resolve(e):window.File&&window.FileReader&&window.URL?e instanceof File?/image/i.test(e.type)?("object"!=typeof t&&(t={}),new Promise(function(n){var o=new FileReader;o.readAsArrayBuffer(e),o.onload=function(o){var s=new Blob([o.target.result]);window.URL=window.URL||window.webkitURL;var a=window.URL.createObjectURL(s),u=new Image;u.src=a,u.onload=function(){var o=i(u,e.type,t),s=r(o);n(s)}}})):Promise.reject(new Error("file is not image")):Promise.reject(new Error("file invalid")):Promise.reject(new Error("File API not support"))}function i(e,t,n){var i=e.width,r=e.height,o=n.max_width||i,s=n.max_height||r,a=n.quality||null;i>r?i>o&&(r=Math.round(r*=o/i),i=o):r>s&&(i=Math.round(i*=s/r),r=s);var u=document.createElement("canvas");u.width=i,u.height=r;var l=u.getContext("2d");return l.drawImage(e,0,0,i,r),u.toDataURL(t,a)}function r(e){var t="";t=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);for(var n=e.split(",")[0].split(":")[1].split(";")[0],i=new Uint8Array(t.length),r=0;r<t.length;r++)i[r]=t.charCodeAt(r);return new Blob([i],{type:n})}var o="undefined"!=typeof window?window.ES6Promise:"undefined"!=typeof e?e.ES6Promise:null;o&&o.polyfill(),t.exports=n}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],3:[function(e,t){(function(n){"use strict";function i(e){if(!(this instanceof i))return new i(e);"object"!=typeof e&&(e={});var t={trigger:null,name:"file",action:"/upload",accept:null,data:null,multiple:!0,select:null,error:null,success:null,progress:null,compress:!1};$.extend(t,e),this.settings=t,this.setup(),this.bind()}function r(e){if(!e)return[];var t,n=[];for(var i in e)t=document.createElement("input"),t.type="hidden",t.name=i,t.value=e[i],n.push(t);return n}function o(e){for(var t=e.parentsUntil("body"),n=0,i=0;i<t.length;i++){var r=t.eq(i);"static"!==r.css("position")&&(n=parseInt(r.css("zIndex"),10)||n)}return n}function s(){var e="iframe-Upload-"+l,t=$('<iframe name="'+e+'" />').hide();return l+=1,t}var a="undefined"!=typeof window?window.ES6Promise:"undefined"!=typeof n?n.ES6Promise:null,u=e("./compress");a&&a.polyfill();var l=0,f=1e4,p=0;i.prototype.setup=function(){this.form=$('<form method="post" enctype="multipart/form-data"target="" action="'+this.settings.action+'" />');var e=this.settings.data;this.form.append(r(e));var t=document.createElement("input");t.type="file",t.name=this.settings.name,this.settings.accept&&(t.accept=this.settings.accept),this.settings.multiple&&(t.multiple=!0,t.setAttribute("multiple","multiple")),this.input=$(t);var n=$(this.settings.trigger);this.input.attr("hidefocus",!0).css({position:"absolute",top:0,right:0,opacity:0,outline:0,cursor:"pointer",height:n.outerHeight(),fontSize:Math.max(64,5*n.outerHeight())}),this.form.append(this.input),this.form.css({position:"absolute",top:n.offset().top,left:n.offset().left,overflow:"hidden",width:n.outerWidth(),height:n.outerHeight(),zIndex:o(n)+10}).appendTo("body")},i.prototype.bind=function(){var e=this,t=$(e.settings.trigger);t.mouseenter(function(){e.form.css({top:t.offset().top,left:t.offset().left,width:t.outerWidth(),height:t.outerHeight()})}),e.bindInput()},i.prototype.bindInput=function(){var e=this;e.files=[],e.input.change(function(t){e.files=this.files||[{name:t.target.value.split("\\").pop()}],e.uids=$.map(e.files,function(){return p++}),e.settings.select?e.settings.select.call(e,e.files,e.uids):e.submit()})},i.prototype.submit=function(){window.FormData?this.ajaxSubmit():this.formSubmit()},i.prototype.ajaxSubmit=function(){var e=this,t=e.files;e.input.prop("disabled",!0);var n=new FormData(e.form.get(0));e.input.prop("disabled",!1);var i=[];$.each(t,function(t,r){var o=u(r,e.settings.compress)["catch"](function(n){e.settings.error&&e.settings.error(new Error("compress error: "+n.message),e.uids[t])}).then(function(i){return i=i||r,n.append(e.settings.name,i,r.name),new Promise(function(i){$.ajax({url:e.settings.action,type:"post",processData:!1,contentType:!1,data:n,timeout:f,xhr:function(){var n=$.ajaxSettings.xhr();return n.upload&&e.settings.progress&&n.upload.addEventListener("progress",function(n){var i=0,r=n.loaded||n.position,o=n.total;n.lengthComputable&&(i=Math.ceil(r/o*100)),e.settings.progress(r,o,i,e.uids[t])},!1),n},success:function(n){e.settings.success&&e.settings.success(n,e.uids[t]),i()},error:function(n,r){e.settings.error&&e.settings.error(new Error("upload error: "+r),e.uids[t]),i()}})})});i.push(o)}),Promise.all(i).then(function(){e.refreshInput()})},i.prototype.formSubmit=function(){var e=this;e.iframe=s(),e.form.attr("target",e.iframe.attr("name")),e.iframe.data("uid",e.uids[0]),$("body").append(e.iframe);var t=null;e.iframe.one("load",function(){clearTimeout(t),$('<iframe src="javascript:false;"></iframe>').appendTo(e.form).remove();var n=null;try{n=$.trim($(this).contents().find("body").html())}catch(i){e.settings.error&&e.settings.error(new Error("upload error: cross domain"),$(this).data("uid"))}finally{null!==n&&e.settings.success&&e.settings.success(n,$(this).data("uid")),e.refreshInput(),$(this).remove()}}),e.form.submit(),t=setTimeout(function(){e.settings.error&&e.settings.error(new Error("upload error: timeout"),e.iframe.data("uid")),e.refreshInput(),e.iframe.remove()},f)},i.prototype.refreshInput=function(){var e=this.input.clone();this.input.before(e),this.input.off("change"),this.input.remove(),this.input=e,this.bindInput()},i.prototype.select=function(e){return e?(this.settings.select=e,this):this},i.prototype.success=function(e){return e?(this.settings.success=e,this):this},i.prototype.error=function(e){return e?(this.settings.error=e,this):this},i.prototype.progress=function(e){return e?(this.settings.progress=e,this):this},t.exports=i}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./compress":2}],4:[function(e,t,n){(function(e){"use strict";var t="undefined"!=typeof window?window.ES6Promise:"undefined"!=typeof e?e.ES6Promise:null;t&&t.polyfill();var i=function(e,t){return new Promise(function(n,i){$.ajax({url:e,data:t,dataType:"json",success:function(e){e.success?n(e.message):i(new Error("server_config error: "+e.message))},error:function(e,t){i(new Error("server_config error: "+t))}})})};n.getConfig=function(e,t){if("image"===e){window.location.origin=window.location.origin||window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"");var n=window.location.origin+"/imageUpload/getConfig/",r={vendor:t,"return-url":window.location.origin+"/imageUpload/getResult/"};return window.FormData&&delete r["return-url"],window[t]?Promise.resolve({action:window[t].uploadUrl,data:window[t].uploadParams,name:window[t].fileKey}):i(n,r).then(function(e){return{action:e.uploadUrl,data:e.uploadParams,name:e.fileKey}})}return Promise.reject(new Error("server_config error: media type invalid"))}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1])(1)});
//# sourceMappingURL=image_upload.min.js.map