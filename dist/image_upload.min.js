!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.imageUpload=e()}}(function(){return function e(t,i,n){function o(s,u){if(!i[s]){if(!t[s]){var a="function"==typeof require&&require;if(!u&&a)return a(s,!0);if(r)return r(s,!0);var f=new Error("Cannot find module '"+s+"'");throw f.code="MODULE_NOT_FOUND",f}var l=i[s]={exports:{}};t[s][0].call(l.exports,function(e){var i=t[s][1][e];return o(i?i:e)},l,l.exports,e,t,i,n)}return i[s].exports}for(var r="function"==typeof require&&require,s=0;s<n.length;s++)o(n[s]);return o}({1:[function(e,t){function i(e,t){return"object"==typeof e&&(t=e,e="upyun"),e=e||"upyun","object"!=typeof t&&(t={}),o.getConfig("image",e).then(function(e){return $.extend(e,{accept:"image/*",timeout:5e3,compress:{max_width:300,max_height:300}},t),new n(e)})}var n=e("./lib/upload"),o=e("./lib/vendor");getThumbnailUrl=function(e,t,i){e=e||"upyun";var n=t.url||t.upload_ret.url;return n=n.split("#")[0],i=i?"_"+i:"_sq","upyun"===e?"http://img"+(n.charCodeAt(1)%3+4)+".baixing.net"+n+i:"qiniu"===e?"http://img7.baixing.net/"+n+i:void 0},getUrl=function(e,t){e=e||"upyun";var i=t.url||t.upload_ret.url;i=i.split("#")[0];var n="";return"upyun"===e||"upyun_im"===e?n="#up":"qiniu"===e&&(n="#qn"),i+n},t.exports=i,$(function(){$("[data-image-upload]").each(function(e,t){var n=$(t).data("vendor"),o=$(t).data("suffix");i(n,{trigger:$(t),success:function(e,i){if("string"==typeof e&&(e=$.parseJSON(e)),200===e.code||"qiniu"===n&&!e.error){var r=getThumbnailUrl(n,e,o),s=getUrl(n,e);$(t).trigger("imageUploadSuccess",[r,s,i])}else $(t).trigger("imageUploadError",[e.message||e.error,i])},error:function(e,i){"upload error: timeout"===e.message&&$(t).trigger("imageUploadTimeout",[i]),$(t).trigger("imageUploadError",[e.message,i])},progress:function(){$(t).trigger("imageUploadProgress",[].slice.call(arguments,0))},select:function(){$(t).trigger("imageUploadSelect",[].slice.call(arguments,0)),this.submit()}})["catch"](function(e){$(t).trigger("imageUploadError",e.message)})})})},{"./lib/upload":3,"./lib/vendor":4}],2:[function(e,t){(function(e){"use strict";function i(e,t){return t===!1?Promise.resolve(e):window.File&&window.FileReader&&window.URL?e instanceof File?/image/i.test(e.type)?("object"!=typeof t&&(t={}),new Promise(function(i){var r=new FileReader;r.readAsArrayBuffer(e),r.onload=function(r){var s=new Blob([r.target.result]);window.URL=window.URL||window.webkitURL;var u=window.URL.createObjectURL(s),a=new Image;a.src=u,a.onload=function(){var r=n(a,e.type,t),s=o(r);i(s)}}})):Promise.reject(new Error("file is not image")):Promise.reject(new Error("file invalid")):Promise.reject(new Error("File API not support"))}function n(e,t,i){var n=e.width,o=e.height,r=i.max_width||n,s=i.max_height||o,u=i.quality||null;n>o?n>r&&(o=Math.round(o*=r/n),n=r):o>s&&(n=Math.round(n*=s/o),o=s);var a=document.createElement("canvas");a.width=n,a.height=o;var f=a.getContext("2d");return f.drawImage(e,0,0,n,o),a.toDataURL(t,u)}function o(e){var t="";t=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);for(var i=e.split(",")[0].split(":")[1].split(";")[0],n=new Uint8Array(t.length),o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return new Blob([n],{type:i})}var r="undefined"!=typeof window?window.ES6Promise:"undefined"!=typeof e?e.ES6Promise:null;r.polyfill(),t.exports=i}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],3:[function(e,t){(function(i){"use strict";function n(e){if(!(this instanceof n))return new n(e);"object"!=typeof e&&(e={});var t={trigger:null,name:"file",action:"/upload",accept:null,data:null,multiple:!0,select:null,error:null,success:null,progress:null,compress:!1,timeout:1e4};$.extend(t,e),this.settings=t,this.setup(),this.bind()}function o(e){if(!e)return[];var t,i=[];for(var n in e)t=document.createElement("input"),t.type="hidden",t.name=n,t.value=e[n],i.push(t);return i}function r(e){var t=0;return $.each(e.parents(),function(e,i){return i===$("body")[0]?!1:void("static"!==$(i).css("position")&&(t=parseInt($(i).css("zIndex"),10)||t))}),t}function s(){var e="iframe-Upload-"+f,t=$('<iframe name="'+e+'" />').hide();return f+=1,t}var u="undefined"!=typeof window?window.ES6Promise:"undefined"!=typeof i?i.ES6Promise:null,a=e("./compress");u.polyfill();var f=0,l=0;n.prototype.setup=function(){this.form=$('<form method="post" enctype="multipart/form-data"target="" action="'+this.settings.action+'" />');var e=this.settings.data;this.form.append(o(e));var t=document.createElement("input");t.type="file",t.name=this.settings.name,this.settings.accept&&(t.accept=this.settings.accept),this.settings.multiple&&(t.multiple=!0,t.setAttribute("multiple","multiple")),this.input=$(t);var i=$(this.settings.trigger),n=i.outerWidth?i.outerWidth():i[0].offsetWidth,s=i.outerHeight?i.outerHeight():i[0].offsetHeight;this.input.attr("hidefocus",!0).css({position:"absolute",top:0,right:0,opacity:0,outline:0,cursor:"pointer",width:n,height:s,fontSize:Math.max(64,5*s)}),this.form.append(this.input),this.form.css({position:"absolute",top:i.offset().top,left:i.offset().left,overflow:"hidden",width:n,height:s,zIndex:r(i)+10}).appendTo("body")},n.prototype.bind=function(){var e=this,t=$(e.settings.trigger),i=t.outerWidth?t.outerWidth():t[0].offsetWidth,n=t.outerHeight?t.outerHeight():t[0].offsetHeight;t.mouseenter(function(){e.form.css({top:t.offset().top,left:t.offset().left,width:i,height:n})}),e.bindInput()},n.prototype.bindInput=function(){var e=this;e.files=[],e.input.change(function(t){e.files=this.files||[{name:t.target.value.split("\\").pop()}],e.uids=$.map(e.files,function(){return l++}),e.settings.select?e.settings.select.call(e,e.files,e.uids):e.submit()})},n.prototype.submit=function(){window.FormData?(this.ajaxSubmit(this.files,this.uids),this.refreshInput()):this.formSubmit(this.uids[0])},n.prototype.ajaxSubmit=function(e,t){var i=this,n=[];return $.each(e,function(e,o){var r=a(o,i.settings.compress)["catch"](function(){return o}).then(function(t){i.input.prop("disabled",!0);var n=new FormData(i.form.get(0));return n.append(i.settings.name,t,o.name),i.input.prop("disabled",!1),new Promise(function(t,o){$.ajax({url:i.settings.action,type:"post",processData:!1,contentType:!1,data:n,timeout:i.settings.timeout,xhr:function(){var t=$.ajaxSettings.xhr();return t.upload&&i.settings.progress&&t.upload.addEventListener("progress",function(t){var n=0,o=t.loaded||t.position,r=t.total;t.lengthComputable&&(n=Math.ceil(o/r*100)),i.settings.progress(o,r,n,i.uids[e])},!1),t},success:function(e){t(e)},error:function(e,t,i){i&&(i=" "+i);var n="upload error: "+t+i;o(new Error(n))}})})}).then(function(n){i.settings.success&&i.settings.success(n,t[e])},function(n){i.settings.error&&i.settings.error(n,t[e])});n.push(r)}),Promise.all(n)},n.prototype.formSubmit=function(e){var t=this;return new Promise(function(e,i){t.iframe=s(),t.form.attr("target",t.iframe.attr("name")),$("body").append(t.iframe);var n=null;t.iframe.one("load",function(){clearTimeout(n),$('<iframe src="javascript:false;"></iframe>').appendTo(t.form).remove();var i=$.trim($(this).contents().find("body").html());e(i)}),t.form.submit(),t.refreshInput(),n=setTimeout(function(){i(new Error("upload error: timeout"))},t.settings.timeout)}).then(function(i){t.settings.success&&t.settings.success(i,e)},function(i){t.settings.error&&t.settings.error(i,e)}).then(function(){t.iframe.remove()})},n.prototype.refreshInput=function(){var e=this.input.clone();this.input.before(e),this.input.off("change"),this.input.remove(),this.input=e,this.bindInput()},n.prototype.select=function(e){return e?(this.settings.select=e,this):this},n.prototype.success=function(e){return e?(this.settings.success=e,this):this},n.prototype.error=function(e){return e?(this.settings.error=e,this):this},n.prototype.progress=function(e){return e?(this.settings.progress=e,this):this},t.exports=n}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./compress":2}],4:[function(e,t,i){(function(e){"use strict";var t="undefined"!=typeof window?window.ES6Promise:"undefined"!=typeof e?e.ES6Promise:null;t.polyfill();var n=function(e,t){return new Promise(function(i,n){$.ajax({url:e,data:t,dataType:"json",success:function(e){e.success?i(e.message):n(new Error("server_config error: "+e.message))},error:function(e,t,i){i&&(i=" "+i),n(new Error("server_config error: "+t+i))}})})};i.getConfig=function(e,t){if("image"===e){window.location.origin=window.location.origin||window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"");var i=window.location.origin+"/imageUpload/getConfig/",o={vendor:t,"return-url":window.location.origin+"/imageUpload/getResult/"};return window.FormData&&delete o["return-url"],window[t]?Promise.resolve({action:window[t].uploadUrl,data:window[t].uploadParams,name:window[t].fileKey}):n(i,o).then(function(e){return{action:e.uploadUrl,data:e.uploadParams,name:e.fileKey}})}return Promise.reject(new Error("server_config error: media type invalid"))}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1])(1)});
//# sourceMappingURL=image_upload.min.js.map